# Made by: Airil / Ainhoa

import subprocess
import re
import time

from termcolor import colored

def check_wifi_requitxikitos(): # los requitxikitos son los requisitos chikitos, soy gilipollas, ya lo se XD
    pass

def monitor_on(iface):
    try:
        subprocess.run(['ip', 'link', 'set', iface, 'down'], check=True)
        subprocess.run(['iw', iface, 'set', 'monitor', 'none'], check=True)
        subprocess.run(['ip', 'link', 'set', iface, 'up'], check=True)

        print(str(colored("\n[+] Net interface ", 'green') + colored(iface, 'cyan') + colored(" is on monitor mode", 'green')))
        return "ON"

    except subprocess.CalledProcessError as e:
        print(str(colored("\n[!] Couldn't monitor on ", 'red') + colored(iface, 'yellow') + colored(" error: ", 'red') + colored(e, 'yellow')))
        return "OFF"
    
def wifiscan(iface):
    check_wifi_requitxikitos()

    try:
        try:
            subprocess.Popen(['rm', '/tmp/airodump_output-01.csv'], stdout = subprocess.DEVNULL, stderr = subprocess.STDOUT)
        except:
            pass

        airodump_process = subprocess.Popen(['airodump-ng', iface, '--write-interval', '1', '--output-format', 'csv', '--write', '/tmp/airodump_output'], stdout = subprocess.DEVNULL, stderr = subprocess.STDOUT)
        print(colored("\n[+] Scanning networks... Please wait a few seconds", 'green'))
        time.sleep(5)
        airodump_process.terminate()

        with open('/tmp/airodump_output-01.csv', 'r') as file:
            lines = file.readlines()

        print(colored("\nNETWORKS:\n", 'green', attrs=['dark', 'underline']))

        bssid_list = []
        channel_list = []
        n = 0

        for i, line in enumerate(lines):            
            if i == 1: # salto la primera linea que es una descripciÃ³n de que es cada columna
                continue

            if ' First time seen' in line and 'Cipher' not in line: # lo de que no este el cipher es porque al principio hay una linea como la que quiero usar como limite pero con mas argumentos, entonces como en la de limite no esta ese lo utilizo como limite 
                break

            if line.strip() == '': # salta las lineas vacias
                continue

            parts = line.split(',')
            bssid = parts[0]
            channel = parts[3]
            privacy = parts[5]
            cipher = parts[6]
            power = parts[8]
            essid = parts[13]
            if essid.strip() == '':
                essid = 'unknown'

            bssid_list.append(bssid)
            channel_list.append(channel)
            n += 1

            print(str(colored(str(str(n) + " - "), 'yellow') + colored("ESSID: ", 'green') + colored(essid.strip(), 'cyan') + colored(" BSSID: ", 'green') + colored(bssid, 'cyan') + colored(" CHANNEL: ", 'green') + colored(channel, 'cyan') + colored(" PRIVACY: ", 'green') + colored(privacy, 'cyan') + colored(" CIPHER: ", 'green') + colored(cipher, 'cyan') + colored(" POWER: ", 'green') + colored(power, 'cyan')))

        nn = input(str(colored("\nThunderDragon", 'blue') + colored(" Network Number > ", 'red'))).lower().strip()
        network = bssid_list[int(nn)-1]

        try:
            subprocess.Popen(['rm', '/tmp/ad_output-01.csv'], stdout = subprocess.DEVNULL, stderr = subprocess.STDOUT)
        except:
            pass

        airodump_process = subprocess.Popen(['airodump-ng', iface, '--bssid', network, '--channel', channel_list[int(nn)-1], '--write-interval', '1', '--output-format', 'csv', '--write', '/tmp/ad_output'], stdout = subprocess.DEVNULL, stderr = subprocess.STDOUT)
        print(colored("\n[+] Scanning ", 'green') + colored(network, 'cyan') + colored(" network... Please wait a few seconds", 'green'))
        time.sleep(20)
        airodump_process.terminate()

        with open('/tmp/airodump_output-01.csv', 'r') as file:
            lines = file.readlines()

        print(lines)

    except Exception as e:
        print(str(colored("\n[!] Error scanning Wifi networks: ", 'red') + colored(e, 'yellow')))
